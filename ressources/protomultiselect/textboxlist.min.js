var ResizableTextbox=Class.create({options:$H({min:5,max:500,step:7}),initialize:function(b,a){var c=this;this.options.update(a);this.el=$(b);this.width=this.el.offsetWidth;this.el.observe("keyup",function(){var d=c.options.get("step")*$F(this).length;if(d<=c.options.get("min")){d=c.width;}if(!($F(this).length==this.retrieveData("rt-value")||d<=c.options.min||d>=c.options.max)){this.setStyle({width:d});}}).observe("keydown",function(){this.cacheData("rt-value",$F(this).length);});}});var TextboxList=Class.create({options:$H({resizable:{},className:"bit",separator:"###",extrainputs:true,startinput:true,hideempty:true,fetchFile:undefined,results:10,wordMatch:false}),initialize:function(b,a){this.options.update(a);this.element=$(b).hide();this.bits=new Hash();this.events=new Hash();this.count=0;this.current=false;this.maininput=this.createInput({"class":"maininput"});this.holder=new Element("ul",{"class":"holder"}).insert(this.maininput);this.element.insert({before:this.holder});this.holder.observe("click",function(c){c.stop();if(this.maininput!=this.current){this.focus(this.maininput);}}.bind(this));this.makeResizable(this.maininput);this.setEvents();},setEvents:function(){document.observe(Prototype.Browser.IE?"keydown":"keypress",function(a){if(!this.current){return;}if(this.current.retrieveData("type")=="box"&&a.keyCode==Event.KEY_BACKSPACE){a.stop();}}.bind(this));document.observe("keyup",function(a){a.stop();if(!this.current){return;}switch(a.keyCode){case Event.KEY_LEFT:return this.move("left");case Event.KEY_RIGHT:return this.move("right");case Event.KEY_DELETE:case Event.KEY_BACKSPACE:return this.moveDispose();}}.bind(this)).observe("click",function(){document.fire("blur");}.bindAsEventListener(this));},update:function(){this.element.value=this.bits.values().join(this.options.get("separator"));return this;},add:function(c,a){var d=this.options.get("className")+"-"+this.count++;var b=this.createBox($pick(a,c),{id:d});(this.current||this.maininput).insert({before:b});b.observe("click",function(f){f.stop();this.focus(b);}.bind(this));this.bits.set(d,c.value);if(this.options.get("extrainputs")&&(this.options.get("startinput")||b.previous())){this.addSmallInput(b,"before");}return b;},addSmallInput:function(c,b){var a=this.createInput({"class":"smallinput"});c.insert({}[b]=a);a.cacheData("small",true);this.makeResizable(a);if(this.options.get("hideempty")){a.hide();}return a;},dispose:function(a){this.bits.unset(a.id);if(a.previous()&&a.previous().retrieveData("small")){a.previous().remove();}if(this.current==a){this.focus(a.next());}if(a.retrieveData("type")=="box"){a.onBoxDispose(this);}a.remove();return this;},focus:function(b,a){if(!this.current){b.fire("focus");}else{if(this.current==b){return this;}}this.blur();b.addClassName(this.options.get("className")+"-"+b.retrieveData("type")+"-focus");if(b.retrieveData("small")){b.setStyle({display:"block"});}if(b.retrieveData("type")=="input"){b.onInputFocus(this);if(!a){this.callEvent(b.retrieveData("input"),"focus");}}else{b.fire("onBoxFocus");}this.current=b;return this;},blur:function(b){if(!this.current){return this;}if(this.current.retrieveData("type")=="input"){var a=this.current.retrieveData("input");if(!b){this.callEvent(a,"blur");}a.onInputBlur(this);}else{this.current.fire("onBoxBlur");}if(this.current.retrieveData("small")&&!a.get("value")&&this.options.get("hideempty")){this.current.hide();}this.current.removeClassName(this.options.get("className")+"-"+this.current.retrieveData("type")+"-focus");this.current=false;return this;},createBox:function(b,a){return new Element("li",a).addClassName(this.options.get("className")+"-box").update(b.caption).cacheData("type","box");},createInput:function(b){var a=new Element("li",{"class":this.options.get("className")+"-input"});var d=new Element("input",Object.extend(b,{type:"text"}));d.observe("click",function(f){f.stop();}).observe("focus",function(f){if(!this.isSelfEvent("focus")){this.focus(a,true);}}.bind(this)).observe("blur",function(){if(!this.isSelfEvent("blur")){this.blur(true);}}.bind(this)).observe("keydown",function(f){this.cacheData("lastvalue",this.value).cacheData("lastcaret",this.getCaretPosition());});var c=a.cacheData("type","input").cacheData("input",d).insert(d);return c;},callEvent:function(b,a){this.events.set(a,b);b[a]();},isSelfEvent:function(a){return(this.events.get(a))?!!this.events.unset(a):false;},makeResizable:function(a){var b=a.retrieveData("input");b.cacheData("resizable",new ResizableTextbox(b,Object.extend(this.options.get("resizable"),{min:b.offsetWidth,max:(this.element.getWidth()?this.element.getWidth():0)})));return this;},checkInput:function(){var a=this.current.retrieveData("input");return(!a.retrieveData("lastvalue")||(a.getCaretPosition()===0&&a.retrieveData("lastcaret")===0));},move:function(b){var a=this.current[(b=="left"?"previous":"next")]();if(a&&(!this.current.retrieveData("input")||((this.checkInput()||b=="right")))){this.focus(a);}return this;},moveDispose:function(){if(this.current.retrieveData("type")=="box"){return this.dispose(this.current);}if(this.checkInput()&&this.bits.keys().length&&this.current.previous()){return this.focus(this.current.previous());}}});Element.addMethods({getCaretPosition:function(){if(this.createTextRange){var a=document.selection.createRange().duplicate();a.moveEnd("character",this.value.length);if(a.text===""){return this.value.length;}return this.value.lastIndexOf(a.text);}else{return this.selectionStart;}},cacheData:function(b,a,c){if(Object.isUndefined(this[$(b).identify()])||!Object.isHash(this[$(b).identify()])){this[$(b).identify()]=$H();}this[$(b).identify()].set(a,c);return b;},retrieveData:function(b,a){return this[$(b).identify()].get(a);}});function $pick(){for(var b=0,a=arguments.length;b<a;b++){if(!Object.isUndefined(arguments[b])){return arguments[b];}}return null;}